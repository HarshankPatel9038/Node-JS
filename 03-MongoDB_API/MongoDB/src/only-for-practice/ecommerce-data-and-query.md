1. Find the total number of active categories.
from Category
[
  {
    $match: {
      isActive: true
    }
  },
  {
    $count: 'Total Active Category'
  }
]



2. Retrieve the list of users who have made more than 2 orders.
from Order
[
  {
    $group: {
      _id: "$user_id",
      "count_order": {
        $sum: 1
      },
      order_id: {$push: "$_id"}
    }
  },
  {
    $match: {
      count_order: {$gte: 2}
    }
  },
  {
    $lookup: {
      from: "users",
      localField: "_id",
      foreignField: "_id",
      as: "users"
    }
  },
  {
    $unwind: {
      path: "$users"
    }
  },
  {
    $project: {
      _id: 1,
      order_id: 1,
      count_order: 1,
      name: "$users.name",
      mobile_no: "$users.mobile_no"
    }
  }
]



3. Calculate the total revenue generated by each seller.
from Order
[
  {
    $group: {
      _id: "$seller_id",
      "total_revenue": {
        $sum: "$total_amount"
      }
    }
  },
  {
    $lookup: {
      from: "users",
      localField: "_id",
      foreignField: "_id",
      as: "users"
    }
  },
  {
    $unwind: {
      path: "$users"
    }
  },
  {
    $project: {
      _id: 1,
      name: "$users.name",
      total_revenue: 1,
    }
  }
]



4. Retrieve the products with the highest average rating.
from Review
[
  {
    $group: {
      _id: "$product_id",
      "revenue_rating": {
       $avg: "$rating"
      }
    }
  },
  {
    $sort: {
      revenue_rating: -1
    }
  },
  {
    $limit: 2
  },
  {
    $lookup: {
      from: "products",
      localField: "_id",
      foreignField: "_id",
      as: "products"
    }
  },
  {
    $unwind: {
      path: "$products"
    }
  },
  {
    $project: {
      _id: 1,
      name: "$products.name",
      revenue_rating: 1,
    }
  }
]



5. Calculate the total number of products in each subcategory.
from Subcategory
[
  {
    $group: {
      _id: "$subcategory_id",
      "total_product": {
        $sum: 1
      }
    }
  },
  {
    $lookup: {
      from: "subcategories",
      localField: "_id",
      foreignField: "_id",
      as: "subcategories"
    }
  },
  {
    $unwind: {
      path: "$subcategories"
    }
  },
  {
    $project: {
      _id: 1,
      total_product: 1,
      name: "$subcategories.subcategory_name"
    }
  }
]



6. Find the users who have not made any orders.
from User
[
  {
    $lookup: {
      from: "orders",
      localField: "_id",
      foreignField: "user_id",
      as: "result"
    }
  },
  {
    $match: {
     result: {$eq: []}
    }
  },
  {
    $project: {
      name: 1
    }
  }
]



7. Identify the most popular product (highest number of reviews).
from Review
[
  {
    $group: {
      _id: "$product_id",
      "total_review": {
        $sum: 1
      }
    }
  },
  {
    $sort: {
      total_review: -1
    }
  },
  {
    $limit: 1
  },
  {
    $lookup: {
      from: "products",
      localField: "_id",
      foreignField: "_id",
      as: "products"
    }
  },
  {
    $unwind: {
      path: "$products"
    }
  },
  {
    $project: {
      _id: 1,
      name: "$products.name",
     total_review: 1
    }
  }
]



8. Calculate the total revenue and average order value for each seller.
from Order
[
  {
    $group: {
      _id: "$seller_id",
      total_revenue: {
        $sum: "$total_amount"
      },
      total_orders: {
        $sum: 1
      },
      total_order_amount: {
        $sum: "$total_amount"
      }
    }
  },
  {
    $lookup: {
      from: "users",
      localField: "_id",
      foreignField: "_id",
      as: "users"
    }
  },
  {
    $unwind: {
      path: "$users"
    }
  },
  {
    $project: {
      _id: 1,
      name: "$users.name",
      total_revenue: 1,
      average_order_value: {
        $divide: ["$total_order_amount", "$total_orders"]
      }
    }
  }
]



9. Find the products with a quantity less than 20 in the Variant collection.
from Variant
[
  {
    $match: {
      "attributes.Quantity": {
        $lt: 20
      }
    }
  },
  {
    $lookup: {
      from: "products",
      localField: "product_id",
      foreignField: "_id",
      as: "products"
    }
  },
  {
    $unwind: {
      path: "$products",
    }
  },
  {
    $project: {
      name: "$products.name"
    }
  }
]




10. Retrieve the top 5 customers with the highest total order value.
from Order
[
  {
    $group: {
      _id: "$user_id",
      "count_order": {
        $sum: 1
      }
    }
  },
  {
    $sort: {
      count_order: -1
    }
  },
  {
    $limit: 5
  },
  {
    $lookup: {
      from: "users",
      localField: "_id",
      foreignField: "_id",
      as: "users"
    }
  },
  {
    $unwind: {
      path: "$users",
    }
  },
  {
    $project: {
      _id: 1,
      count_order: 1,
      name: "$users.name"
    }
  }
]



11. Find the average rating for each product.
from Review
[
  {
    $group: {
      _id: "$product_id",
      "avg_rating": {
        $avg: "$rating"
      }
    }
  },
  {
    $lookup: {
      from: "products",
      localField: "_id",
      foreignField: "_id",
      as: "result"
    }
  },
  {
    $unwind: {
      path: "$result",
    }
  },
  {
    $project: {
      avg_rating: 1,
      name: "$result.name"
    }
  }
]



12. Retrieve the latest 5 reviews with user details.
from Review
[
  {
    $group: {
      _id: "$user_id",
    }
  },
  {
    $sort: {
      _id: -1
    }
  },
  {
    $limit: 5
  },
  {
    $lookup: {
      from: "users",
      localField: "_id",
      foreignField: "_id",
      as: "result"
    }
  },
  {
    $unwind: {
      path: "$result",
    }
  },
  {
    $project: {
      name: "$result.name",
      address: "$result.address",
      mobile_no: "$result.mobile_no",
      email: "$result.email",
    }
  }
]



13. Identify the users who have items in their cart with a quantity greater than 5.
from Cart
[
  {
    $unwind: {
      path: "$items"
    }
  },
  {
    $group: {
      _id: "$user_id",
      "quantity": {
        $sum: "$items.quantity"
      }
    }
  },
  {
    $match: {
      quantity: {
        $gt: 5
      }
    }
  },
  {
    $lookup: {
      from: 'users',
      localField: '_id',
      foreignField: '_id',
      as: 'result'
    }
  },
  {
    $unwind: {
      path: '$result',
    }
  },
  {
    $project: {
      name: '$result.name',
      quantity: 1
    }
  }
]



14. Calculate the total number of orders placed using each payment gateway.
from Payment
[
  {
    $group: {
        _id: "$gateway",
       'total_gateway': {
         $sum: 1
       },
      order_id: {
        $push: "$order_id"
      }
    }
  },
  {
    $lookup: {
      from: 'orders',
      localField: 'order_id',
      foreignField: '_id',
      as: 'result'
    }
  },
  {
    $unwind: {
      path: '$result'
    }
  }
]



15. Find the subcategories with no active products.
from Product
[
  {
    $match: {
      isActive: false
    }
  },
  {
    $lookup: {
      from: 'subcategories',
      localField: 'subcategory_id',
      foreignField: '_id',
      as: 'result'
    }
  },
  {
    $unwind: {
      path: '$result'
    }
  },
  {
    $project: {
      subcategory_name: '$result.subcategory_name',
      produt_name: '$name',
      isActive: 1
    }
  }
]



16. Retrieve the orders with a total amount greater than 400 and status as "Completed."
from Order
[
  {
    $match: {
      status: 'Completed',
      total_amount: {$gt: 400}
    }
  }
]



17. Identify the products that have not been reviewed.
from Product
[
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "product_id",
      as: "result"
    }
  },
  {
    $match: {
      result: []
    }
  }
]



18. Calculate the total revenue and total quantity sold for each product.
from Order
[
  {
    $unwind: {
      path: '$products'
    }
  },
  {
    $group: {
      _id: '$products.product_id',
      'total_qty': {
        $sum: '$products.quantity'
      },
      'total_amount': {
        $sum: '$total_amount'
      }
    }
  },
  {
    $lookup: {
      from: 'products',
      localField: '_id',
      foreignField: '_id',
      as: 'result'
    }
  },
  {
    $unwind: {
      path: '$result'
    }
  },
  {
    $project: {
      total_qty: 1,
      total_amount: 1,
      product_name: '$result.name'
    }
  }
]



19. Find the top 3 subcategories with the highest average product price.
from Variant
[
  {
    $unwind: {
      path: '$attributes',
    }
  },
  {
    $lookup: {
      from: 'products',
      localField: '_id',
      foreignField: '_id',
      as: 'products_result'
    }
  },
  {
    $unwind: {
      path: '$products_result',
    }
  },
  {
    $lookup: {
      from: 'subcategories',
      localField: 'products_result._id',
      foreignField: '_id',
      as: 'subcategory_result'
    }
  },
  {
    $unwind: {
      path: '$subcategory_result',
    }
  },
  {
    $group: {
      _id: '$subcategory_result._id',
      subcategory_name: {
        $first: "$subcategory_result.subcategory_name"
      },
      avg_price: {
        $avg: '$attributes.Price'
      },
      products: {
        "$push": "$products_result.name"
      }
    }
  },
  {
    $sort: {
      avg_price: -1
    }
  },
  {
    $limit: 3
  },
]



20. Retrieve the products that have received reviews with ratings greater than 4.
from Review
[
  {
    $match: {
      rating: {$gt: 4}
    }
  },
  {
    $lookup: {
      from: 'products',
      localField: 'product_id',
      foreignField: '_id',
      as: 'result'
    }
  },
  {
    $unwind: {
      path: '$result'
    }
  },
  {
    $project: {
      _id: 0,
      product_name: '$result.name',
      rating: 1
    }
  }
]



21. Retrieve product data with their variant details from category.
from categories
[
  {
    $lookup: {
      from: 'subcategories',
      localField: '_id',
      foreignField: 'category_id',
      as: 'subcategories_result'
    }
  },
  {
    $unwind: {
      path: '$subcategories_result',
    }
  },
  {
    $lookup: {
      from: 'products',
      localField: 'subcategories_result._id',
      foreignField: '_id',
      as: 'products_result'
    }
  },
  {
    $unwind: {
      path: '$products_result',
    }
  },
  {
    "$lookup": {
      from: "variants",
      localField: "_id",
      foreignField: "product_id",
      as: "variants_result"
    }
  },
  {
    $unwind: {
      path: '$variants_result',
    }
  },
  {
    $group: {
      _id: '$category_name',
      product_name: {
        $first: "$products_result.name",
      },
      varients: {
        "$push": "$variants_result"
      }
    }
  }
]
or
form products
[
  {
    "$lookup": {
      from: "subcategories",
      localField: "subcategory_id",
      foreignField: "_id",
      as: "subcategory"
    }
  },
  {
    $unwind: "$subcategory"
  },
  {
    "$lookup": {
      from: "categories",
      localField: "subcategory.category_id",
      foreignField: "_id",
      as: "category"
    }
  },
  {
    "$unwind": "$category"
  },
  {
    "$lookup": {
      from: "variants",
      localField: "_id",
      foreignField: "product_id",
      as: "variants"
    }
  },
  {
    "$project": {
      _id: 1,
      category_name: "$category.category_name",
      subcategory_name: "$subcategory.name",
      product_name: "$name",
      variants: 1
    }
  }
]
or
From Category With pipeline
[
  {
    $lookup: {
      from: 'products',
      localField: '_id',
      foreignField: 'category_id',
      as: 'products',
      pipeline: [
        {
          $lookup: {
            from: 'variants',
            localField: '_id',
            foreignField: 'product_id',
            as: 'variants',
          }
      	}
      ]
    }
  },
  {
    $unwind: {
      path: '$products'
    }
  },
  {
    $project: {
      category_name: 1,
      product: {
        product_name: '$products.name',
        variant: '$products.variants'
      }
    }
  }
]



22. Retrieve Categories with Subcategory, Products with product count.
from Subcategory With pipeline
[
  {
    $lookup: {
      from: 'products',
      localField: '_id',
      foreignField: 'subcategory_id',
      as: 'products',
      pipeline: [
        {
          $lookup: {
            from: 'categories',
            localField: 'category_id',
            foreignField: '_id',
            as: 'categories'
          }
      	}
      ]
    }
  },
  {
    $unwind: {
      path: '$products'
    }
  },
  {
    $unwind: {
      path: '$products.categories'
    }
  },
  {
    $group: {
      _id: '$_id',
      category_name: {
        $first: '$products.categories.category_name'
      },
      subcategory_name: {
        $first: '$subcategory_name'
      },
      total_product: {
        $sum: 1
      },
      product_name: {
        $push: '$products.name'
      }
    }
  }
]



23. Retrieve Payments with Order and Product Details.
from Payments With pipeline
[
  {
    $lookup: {
      from: 'orders',
      localField: 'order_id',
      foreignField: '_id',
      as: 'orders',
      pipeline: [{
        $lookup: {
          from: 'products',
          localField: 'products.product_id',
          foreignField: '_id',
          as: 'products'
        }
      }]
    }
  },
  {
    $unwind: {
      path: '$orders',
    }
  },
  {
    $unwind: {
      path: '$orders.products',
    }
  },
  {
    $project: {
      _id: 0,
      order_id: '$orders._id',
      product_name: '$orders.products.name',
      shipping_address: "$orders.shipping_address",
      order_status: "$orders.status",
      discount: "$orders.discount",
      payment_gateway: "$gateway",
      payment_status: "$status"
    }
  }
]